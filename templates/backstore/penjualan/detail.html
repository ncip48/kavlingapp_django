{% extends 'backstore/layout/base.html' %} {% block content %}
{% load custom_filters %}
  <div class="content-header">
    <div class="d-flex align-items-center">
      <div class="me-auto">
        <h4 class="page-title">{{ title }}</h4>
        <div class="d-inline-block align-items-center">
          <nav>
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="{% url 'dashboard' %}"><i class="mdi mdi-home-outline"></i></a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
  <!-- Main content -->
  <section class="content">
    <div class="row">
        <div class="{%if data.tipe_transaksi is not 2 %} col-12 {% else %} col-6 {%endif%}">
            <div class="box">
            <div class="box-header d-flex justify-content-between align-items-center">
                <h4 class="box-title">{{ title }}</h4>
            </div>
            <form novalidate autocomplete="off" method="post" id="main-form" action="{% url 'transaksi_update' data.id %}">
                {% csrf_token %}
                <div class="box-body">
                <input type="hidden" name="kavling_id" class="form-control" id="id_kavling_id" value="{{ kavling.id }}" />
                <div class="col-12">
                    <div class="form-group input-blocks">
                    <label for="id_kode_kavling">Kode Kavling:</label>
                    <input type="text" name="kode_kavling" class="form-control" id="id_kode_kavling" disabled readonly value="{{ data.kavling.kode_kavling }}" />
                    </div>
                    <div class="form-group input-blocks">
                    <label for="id_harga_jual_cash">Harga Jual Cash:</label>
                    <input type="text" name="harga_jual_cash" class="form-control" id="id_harga_jual_cash" disabled readonly value="{{ data.kavling.harga_jual_cash }}" />
                    </div>
                    {% include 'backstore/include/form.html' %}
                    <div class="form-group input-blocks">
                    <label for="id_harga_jual_cash">Tipe Transaksi:</label>
                    <input type="text" name="harga_jual_cash" class="form-control" id="id_harga_jual_cash" disabled readonly value="{{ data.kavling.get_status_real }}" />
                    </div>
                    <div class="form-group input-blocks">
                    <label for="id_harga_jual_cash">Lunas:</label>
                    <input type="text" name="harga_jual_cash" class="form-control" id="id_harga_jual_cash" disabled readonly value="{{ data.kavling.get_status_lunas }}" />
                    </div>
                    {% if data.tipe_transaksi is 0 %}
                    <div class="form-group input-blocks required">
                        <label for="id_tipe_transaksi">Ubah Transaksi:</label>
                        <select name="tipe_transaksi" class="form-control" id="id_tipe_transaksi">
                        <option value="1">Cash</option>
                        <option value="2">Kredit</option>
                        </select>
                    </div>
                    {% endif %}
                    <div class="cash_section">
                    <hr class="mt-20" />
                    <input type="hidden" name="is_lunas" class="form-control" id="id_is_lunas" value="1" />
                    {% include 'backstore/include/form.html' with form=form_cash %}
                    </div>
                    <div class="kredit_section">
                    <hr class="mt-20" />
                    <input type="hidden" name="is_lunas" class="form-control" id="id_is_lunas" value="0" />
                    {% include 'backstore/include/form.html' with form=form_kredit %}
                    </div>
                    <div class="booking_section">
                    <hr class="mt-20" />
                    <input type="hidden" name="is_lunas" class="form-control" id="id_is_lunas" value="0" />
                    {% include 'backstore/include/form.html' with form=form_booking %}
                    </div>
                    Download Kwitansi : <a href="{% url 'generate_kwitansi' data.unique_id %}">Download</a>
                </div>
                </div>
                {%if data.tipe_transaksi is 0 %}
                <div class="box-footer d-flex align-items-center justify-content-end">
                <button type="submit" class="btn btn-sm btn-primary float-end">Simpan</button>
                </div>
                {%endif%}
            </form>
            </div>
        </div>
        {%if data.tipe_transaksi is 2 %}
        <div class="col-6">
            <div class="box">
            <div class="box-header d-flex justify-content-between align-items-center">
                <h4 class="box-title">Riwayat Cicilan</h4>
            </div>
            <div class="box-body">
                <input type="hidden" name="kavling_id" class="form-control" id="id_kavling_id" value="{{ kavling.id }}" />
                <div class="col-12">
                    {% for i in tenor %}
                    <form novalidate autocomplete="off" method="post" id="main-form" action="{% url 'cicilan_create' data.id %}">
                    {% csrf_token %}
                    <div class="form-group input-blocks">
                        <label for="id_tenor_{{ forloop.counter }}">Cicilan ke-{{ forloop.counter }}:</label>
                        <div class="input-group">
                            {% with cicilan=data.cicilan|index_list:forloop.counter|default:"" %}
                                {% if cicilan %}
                                    {% if cicilan.pembayaran_ke == forloop.counter %}
                                        <input type="text" name="tenor_{{ forloop.counter }}" class="form-control" id="id_tenor_{{ forloop.counter }}" readonly disabled value="Pembayaran ke {{cicilan.pembayaran_ke}} : {{cicilan.nominal}} | Tanggal {{cicilan.tanggal_pembayaran}}" />
                                    {% endif %}
                                {% else %}
                                    <input type="hidden" name="pembayaran_ke" class="form-control" id="ipembayaran_ke" value="{{forloop.counter}}" />
                                    <input type="text" class="form-control" readonly disabled value="Belum ada pembayaran" />
                                {% endif %}
                            {% endwith %}

                            {% with cicilan=data.cicilan|index_list:forloop.counter|default:"" %}
                                {% if not cicilan %}
                                    
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-danger btn-sm">Bayar</button>
                                        </div>
                                    
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </form>
                {% endfor %}
                </div>
                </div>
                
            </div>
        </div>
        {%endif%}
    </div>
  </section>
{% endblock %}
{% block script %}
  <script>
    $('.cash_section').hide()
    $('.kredit_section').hide()
    $('.booking_section').hide()
    //add to select option with id_tipe_transaski with <option value="" selected>Pilih Tipe Transaksi</option>
    $('#id_tipe_transaksi').prepend('<option value="" selected>Pilih Tipe Transaksi</option>')
    $('#id_tipe_transaksi').on('change', function () {
      const val = $(this).val()
      if (!val) {
        $('.cash_section').hide()
        $('.kredit_section').hide()
        $('.booking_section').hide()
      } else {
        if (val == '1') {
          $('.cash_section').show()
          $('.kredit_section').hide()
          $('.booking_section').hide()
        } else if (val == '2') {
          $('.cash_section').hide()
          $('.kredit_section').show()
          $('.booking_section').hide()
        }
      }
    })
    
    var rules = {}
    
    // Iterate over input blocks with the class 'required' inside the modal
    $('.input-blocks').each(function () {
      if ($(this).find('[required]').length > 0) {
        // Get the input element inside the current input block
        var formElements = $(this).find('input, select, textarea')
    
        // Iterate over each form element
        formElements.each(function () {
          // Get the element's name attribute
          var fieldName = $(this).attr('name')
    
          // Add the rule to the rules object
          rules[fieldName] = {
            required: true
          }
        })
      }
    })
    
    console.log(rules)
    
    // Initialize form validation with dynamic rules for the form inside the modal
    $('#main-form').validate({
      rules: rules,
      submitHandler: function (form) {
        // Submit the form
        form.submit()
      },
      validClass: 'valid-feedback',
      errorElement: 'div',
      errorClass: 'invalid-feedback',
      errorPlacement: erp,
      highlight: hl,
      unhighlight: uhl,
      success: sc
    })
  </script>
{% endblock %}
